
<!DOCTYPE html>
<html lang="en">
        <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=Edge"/>

        <title>ShaneSpace Blog - Dont store images in your RavenDB</title>
        <meta name="description" content="ShaneSpace Blog" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0">        

        <link type="application/rss+xml" rel="alternate" title="ShaneSpace Blog" href="/feed.rss" />
                <link type="application/atom+xml" rel="alternate" title="ShaneSpace Blog" href="/feed.atom" />
        <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
        <link rel="icon" href="/favicon.ico" type="image/x-icon">

        <link href="/assets/css/bootstrap.min.css" rel="stylesheet" />
        <link href="/assets/css/highlight.css" rel="stylesheet">
        <link href="/assets/css/clean-blog.css" rel="stylesheet" />
        <link href="/assets/css/master.css" rel="stylesheet" />
        <link href="/assets/css/font-awesome.min.css" rel="stylesheet" type="text/css">
        <link href='//fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic' rel='stylesheet' type='text/css'>
        <link href='//fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800' rel='stylesheet' type='text/css'>
        <link href="/assets/css/override.css" rel="stylesheet" />


        <meta name="application-name" content="ShaneSpace Blog" />
        <meta name="msapplication-tooltip" content="ShaneSpace Blog" />
        <meta name="msapplication-starturl" content="/" />

        <meta property="og:title" content="ShaneSpace Blog - Dont store images in your RavenDB" />
        <meta property="og:type" content="website" />
        <meta property="og:url" content="/posts/Dont-store-images-in-your-RavenDB" />
        <!-- TODO: More social graph meta tags -->

        <script src="/assets/js/jquery.min.js"></script>
        <script src="/assets/js/bootstrap.min.js"></script>     
        <script src="/assets/js/highlight.pack.js"></script>   
        <script src="/assets/js/clean-blog.js"></script>
        <script src="/assets/js/d3.v3.min.js"></script>
        <script src="/assets/js/trianglify.min.js"></script>
        <script src="/assets/js/Please-compressed.js"></script>
                
        <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
        <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
        <!--[if lt IE 9]>
                <script src="/assets/js/html5shiv.js"></script>
                <script src="/assets/js/respond.min.js"></script>
        <![endif]-->

        
        


        </head>
        <body>
                
                <!-- Navigation -->
                <nav class="navbar navbar-default navbar-custom navbar-fixed-top">
                        <div class="container-fluid">
                                <!-- Brand and toggle get grouped for better mobile display -->
                                <div class="navbar-header page-scroll">
                                        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#navbar-collapse">
                                        <span class="sr-only">Toggle navigation</span>
                                        <span class="icon-bar"></span>
                                        <span class="icon-bar"></span>
                                        <span class="icon-bar"></span>
                                        </button>
                                        <a class="navbar-brand" href="/">ShaneSpace Blog</a>
                                </div>
                        
                                <!-- Collect the nav links, forms, and other content for toggling -->
                                <div class="collapse navbar-collapse" id="navbar-collapse">
                                        <ul class="nav navbar-nav navbar-right">
                                                        <li><a href="/about">About Me</a></li>
        <li><a href="/tags">All Tags</a></li>
        <li><a href="/posts">Archive</a></li>
        <li><a href="/links">Links</a></li>
 
                                        </ul>
                                </div>
                                <!-- /.navbar-collapse -->
                        </div>
                        <!-- /.container -->
                </nav>
                
                <!-- Page Header -->
                <header class="intro-header" id="intro-header" style="background-image: url(&quot;none&quot;)">
                        <div class="container">
                                <div class="row">
                                        <div class="col-md-12">

    
<div class="post-heading">
    <h1>Dont store images in your RavenDB</h1>
    <div class="meta">        
Published on Monday, December 30, 2013<br>    </div>
        <div class="tags">
                    <a role="button" href="/tags/ravendb" class="btn btn-default btn-xs">RavenDB</a>
                    <a role="button" href="/tags/re-blog" class="btn btn-default btn-xs">re-blog</a>
        </div>     
</div>
                                        </div>
                                </div>
                        </div>
                </header>
                
                <!-- Main Content -->
                <div class="container">
                        <div class="row">
                                <div id="content" class="col-md-12">
                                        

<p>Source: <a href="http://ayende.com/blog/4743/the-design-of-ravendbs-attachments">http://ayende.com/blog/4743/the-design-of-ravendbs-attachments</a></p>
<p>I ws pondering if I could store some images in the RavenDB for simplicity of keeping them with the "Blog" documents, for a movie server I am working on. &nbsp;I stumbled across this article while doing my research...</p>
<p>&nbsp;</p>
<blockquote>Originally posted at 1/6/2011</blockquote>
<p><a href="http://ayende.com/Blog/images/ayende_com/Blog/Windows-Live-Writer/The-design-of-RavenDBs-attachments_D981/image_2.png"><img title="image" src="http://ayende.com/Blog/images/ayende_com/Blog/Windows-Live-Writer/The-design-of-RavenDBs-attachments_D981/image_thumb.png" alt="image" align="right" border="0" /></a>I got a question on attachments in&nbsp;<a href="http://ravendb.net/">RavenDB</a>&nbsp;recently:</p>
<blockquote>
<p>I know that RavenDb allows for attachments. Thinking in terms of facebook photo albums - would raven attachments be suitable?</p>
</blockquote>
<p>And one of the answers from the community was:</p>
<blockquote>
<p>We use attachments and it works ok. We are using an older version of&nbsp; RavenDB (Build 176 unstable), and the thing I wish would happen is that attachments were treated like regular documents in the DB. That way you could query them just like other documents. I am not sure if this was changed in newer releases, but there was talk about it being changed.</p>
<p>If I had to redesign again, I would keep attachments out of the DB cause they are resources you could easily off load to a CDN or cloud service like Amazon or Azure. If the files are in your DB, that makes it more work to optimize later.</p>
<p>In summary: You could put them in the DB, but you could also put ketchup on your ice cream. :)</p>
</blockquote>
<p>I thought that this is a good point to stop and explain a bit about the attachment support in RavenDB. Let us start from the very beginning.</p>
<p>The only reason RavenDB has attachments support is that we wanted to support the notion of Raven Apps (see&nbsp;<a href="http://couchapp.org/page/index">Couch Apps</a>) which are completely hosted in RavenDB. That was the original impetus. Since then, they evolved quite nicely. Attachments in RavenDB can have metadata, are replicated between nodes, can be cascade deleted on document deletions and are HTTP cacheable.</p>
<p>One of the features that was requested several times was automatically turning a binary property to an attachment on the client API. I vetoed that feature for several reasons:</p>
<ul>
<li>It makes things more complicated.</li>
<li>It doesn&rsquo;t actually gives you much.</li>
<li>I couldn&rsquo;t think of a good way to explain the rules governing this without it being too complex.</li>
<li>It encourage storing large binaries in the same place as the actual document.</li>
</ul>
<p>Let us talk in concrete terms here, shall we? Here is my model class:</p>
<blockquote>
<pre class="csharpcode"><span class="kwrd">public</span> <span class="kwrd">class</span> User
{
  <span class="kwrd">public</span> <span class="kwrd">string</span> Id {get;set;}
  <span class="kwrd">public</span> <span class="kwrd">string</span> Name {get;set;}
  <span class="kwrd">public</span> <span class="kwrd">byte</span>[] HashedPassword {get;set;}
  <span class="kwrd">public</span> Bitmap ProfileImage {get;set;}
}</pre>
</blockquote>
<p>From the point of view of the system, how is it supposed to make a distinction between HashedPassword (16 &ndash; 32 bytes, should be stored inside the User document) and ProfileImage (1Kb &ndash; 2 MB, should be stored as a separate attachment).</p>
<p>What is worst, and the main reason why attachments are clearly separated from documents, is that there are some things that we&nbsp;<em>don&rsquo;t</em>&nbsp;want to store inside our document, because that means that:</p>
<ul>
<li>Whenever we pull the document out, we have to pull the image as well.</li>
<li>Whenever we index the document, we need to load the image as well.</li>
<li>Whenever we update the document we need to send the image as well.</li>
</ul>
<p>Do you sense a theme here?</p>
<p>There is another issue, whenever we update the user, we invalidate&nbsp;<em>all&nbsp;</em>the user data. But when we are talking about large files, changing the password doesn&rsquo;t means that you need to invalidate the cached image. For that matter, I really want to be able to load all the images separately and concurrently. If they are stored in the document itself (or even if they are stored as an external attachment with client magic to make it appears that they are in the document) you can&rsquo;t do that.</p>
<p>You might be familiar with this screen:</p>
<p><img src="http://ayende.com/Blog/images/ayende_com/Blog/WindowsLiveWriter/LightSwitchonthewire_8EF2/image_thumb%5B1%5D_f8593434-3dd0-471a-99bf-9fb9149ff5d8.png" alt="image_thumb[1]" /></p>
<p>If we store the image in the Animal document, we run into all of the problems outlined above.</p>
<p>But if we store it as a Url reference to the information, we can then:</p>
<ul>
<li>Load all the images on the form concurrently.</li>
<li>Take advantage of HTTP caching.</li>
<li>Only update the images when they are actually changed.</li>
</ul>
<p>Overall, that is a much nicer system all around.</p>


<div id="disqus_thread"></div>
<script>
/*
*  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
*  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables
*/

var disqus_config = function () {
// this.page.url = '';  // Replace PAGE_URL with your page's canonical URL variable
this.page.identifier = 'Dont-store-images-in-your-RavenDB'; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
};

(function() { // DON'T EDIT BELOW THIS LINE
var d = document, s = d.createElement('script');
s.src = 'https://shanespaceblog.disqus.com/embed.js';
s.setAttribute('data-timestamp', +new Date());
(d.head || d.body).appendChild(s);
})();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
                                </div>
                        </div>
                </div>
                
                <hr>
                
                <!-- Footer -->
                <footer>
                        <div class="container">
        <div class="row">
                <div class="col-md-12 text-center">
                    <p class="copyright text-muted">
                        Copyright © 2017
                        <br />
                            <a href="/feed.rss"><i class="fa fa-rss"></i> RSS Feed</a>
                        |
                            <a href="/feed.atom"><i class="fa fa-rss"></i> Atom Feed</a>
                        <br />
                        <strong><a href="https://wyam.io">Generated by Wyam</a></strong>
                    </p>
                </div>
        </div>
</div>

                </footer> 

                
                <script>hljs.initHighlightingOnLoad();</script>

        </body>
</html>

